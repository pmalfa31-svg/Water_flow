<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Water Flow Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        canvas { margin-bottom: 50px; }
        h2 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Water Dashboard ðŸ’§</h1>
    <p id="status">Caricamento dati...</p>

    <h2>Consumo Dettagliato (Ogni 5 Minuti - Ultime 24h)</h2>
    <canvas id="chart5min"></canvas>

    <h2>Storico Consumo Orario (Ultimo Mese)</h2>
    <canvas id="chartHourly"></canvas>
</div>

<script>
    const PROJECT_URL = "https://yvqknhhptchiknvvtmfo.supabase.co";
    const PUBLIC_KEY = "sb_publishable_tLecHgcJpg6mrIzkQtr4MA_ylz5WnHq"; //
    const supabaseClient = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

    async function fetchData() {
        try {
            // Prendiamo i dati delle ultime 24 ore per il grafico dettagliato
            // e fino a 720 records (1 mese) per quello orario
            const { data, error } = await supabaseClient
                .from('water_measurements')
                .select('*')
                .order('date', { ascending: true })
                .limit(720);

            if (error) throw error;
            document.getElementById('status').innerText = "Dati aggiornati";
            renderCharts(data);
        } catch (err) {
            document.getElementById('status').innerText = "Errore: " + err.message;
        }
    }

    function renderCharts(data) {
        // --- 1. PREPARAZIONE GRAFICO 5 MINUTI ---
        // Prendiamo solo le ultime 24 righe (ultime 24 ore)
        const last24h = data.slice(-24);
        let labels5min = [];
        let values5min = [];

        last24h.forEach(row => {
            const hour = new Date(row.date).getHours();
            // Cicliamo sulle 12 colonne da 5 minuti
            for(let i=1; i<=12; i++) {
                const min = (i-1) * 5;
                const colName = (i*5) + "min";
                labels5min.push(`${hour}:${min < 10 ? '0'+min : min}`);
                values5min.push(row[colName] || 0);
            }
        });

        new Chart(document.getElementById('chart5min'), {
            type: 'line',
            data: {
                labels: labels5min,
                datasets: [{ label: 'Litri / 5min', data: values5min, borderColor: '#28a745', tension: 0.1, fill: true }]
            }
        });

        // --- 2. PREPARAZIONE GRAFICO STORICO MENSILE ---
        new Chart(document.getElementById('chartHourly'), {
            type: 'bar', // Istogramma per lo storico mensile Ã¨ piÃ¹ leggibile
            data: {
                labels: data.map(d => new Date(d.date).toLocaleDateString() + " " + new Date(d.date).getHours() + ":00"),
                datasets: [{ label: 'Consumo Orario Totale (L)', data: data.map(d => d.flow_rate), backgroundColor: '#007bff' }]
            },
            options: { scales: { x: { display: false } } } // Nascondiamo le label x se sono troppe
        });
    }

    fetchData();
</script>
</body>
</html>
</html>




